import React, { useState, useEffect } from 'react';
import { View, Text, StyleSheet, ScrollView, TouchableOpacity, TextInput, Alert, RefreshControl, ActivityIndicator } from 'react-native';
import { SafeAreaView } from 'react-native-safe-area-context';
import AsyncStorage from '@react-native-async-storage/async-storage';
import { colors } from '../theme/colors';
import { offersAPI } from '../api/offers2';

const statusConfig = {
  pending: { label: 'Pending', color: '#f59e0b', bgColor: '#fef3c7', emoji: '‚è≥' },
  accepted: { label: 'Accepted', color: '#10b981', bgColor: '#d1fae5', emoji: '‚úÖ' },
  declined: { label: 'Declined', color: '#ef4444', bgColor: '#fee2e2', emoji: '‚ùå' },
};

export default function MyOffersScreen({ navigation }) {
  const [selectedFilter, setSelectedFilter] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [offers, setOffers] = useState([]);
  const [stats, setStats] = useState({ total: 0, pending: 0, accepted: 0, declined: 0 });
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  // Load offers when screen mounts
  useEffect(() => {
    loadMyOffers();
  }, []);

  // Reload when screen comes into focus
  useEffect(() => {
    const unsubscribe = navigation.addListener('focus', () => {
      loadMyOffers();
    });
    return unsubscribe;
  }, [navigation]);

  const loadMyOffers = async () => {
    try {
      console.log('üìã Loading my offers...');

      // Call backend API (no token needed - handled internally)
      const response = await offersAPI.getMyOffers();
      
      console.log('‚úÖ My offers loaded:', response);

      if (response.success) {
        setOffers(response.offers || []);
        setStats(response.stats || { total: 0, pending: 0, accepted: 0, declined: 0 });
      } else {
        Alert.alert('Error', response.message || 'Failed to load offers');
      }
    } catch (error) {
      console.error('‚ùå Load my offers error:', error);
      Alert.alert('Error', 'Unable to load your offers. Please try again.');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  };

  const onRefresh = () => {
    setRefreshing(true);
    loadMyOffers();
  };

  // Filter offers
  const filteredOffers = offers.filter(offer => {
    const matchesFilter = selectedFilter === 'all' || offer.status === selectedFilter;
    const matchesSearch = !searchQuery || 
      offer.needTitle?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      offer.needCategory?.toLowerCase().includes(searchQuery.toLowerCase());
    return matchesFilter && matchesSearch;
  });

  const formatCurrency = (amount) => {
    return `$${parseFloat(amount).toFixed(2)}`;
  };

  const getTimeAgo = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return `${Math.floor(seconds / 604800)}w ago`;
  };

  return (
    <SafeAreaView style={styles.container}>
      {/* Header */}
      <View style={styles.header}>
        <View>
          <Text style={styles.title}>My Offers</Text>
          <Text style={styles.subtitle}>Track your submitted offers</Text>
        </View>
        <TouchableOpacity 
          style={styles.settingsButton}
          onPress={() => navigation.navigate('Profile')}
        >
          <Text style={styles.settingsIcon}>‚öôÔ∏è</Text>
        </TouchableOpacity>
      </View>

      {/* Stats Cards */}
      <View style={styles.statsContainer}>
        <View style={[styles.statCard, { backgroundColor: '#fef3c7' }]}>
          <Text style={styles.statNumber}>{stats.pending}</Text>
          <Text style={styles.statLabel}>Pending</Text>
        </View>
        <View style={[styles.statCard, { backgroundColor: '#d1fae5' }]}>
          <Text style={styles.statNumber}>{stats.accepted}</Text>
          <Text style={styles.statLabel}>Accepted</Text>
        </View>
        <View style={[styles.statCard, { backgroundColor: '#fee2e2' }]}>
          <Text style={styles.statNumber}>{stats.declined}</Text>
          <Text style={styles.statLabel}>Declined</Text>
        </View>
      </View>

      {/* Search */}
      <View style={styles.searchContainer}>
        <Text style={styles.searchIcon}>üîç</Text>
        <TextInput
          style={styles.searchInput}
          placeholder="Search offers..."
          value={searchQuery}
          onChangeText={setSearchQuery}
        />
      </View>

      {/* Filters */}
      <ScrollView horizontal showsHorizontalScrollIndicator={false} style={styles.filtersScroll}>
        {['all', 'pending', 'accepted', 'declined'].map((filter) => (
          <TouchableOpacity
            key={filter}
            style={[styles.filterChip, selectedFilter === filter && styles.filterChipActive]}
            onPress={() => setSelectedFilter(filter)}
          >
            <Text style={[styles.filterChipText, selectedFilter === filter && styles.filterChipTextActive]}>
              {filter === 'all' ? 'All' : statusConfig[filter].label}
            </Text>
          </TouchableOpacity>
        ))}
      </ScrollView>

      {/* Offers List */}
      {loading ? (
        <View style={styles.loadingContainer}>
          <ActivityIndicator size="large" color={colors.primary} />
          <Text style={styles.loadingText}>Loading offers...</Text>
        </View>
      ) : filteredOffers.length === 0 ? (
        <View style={styles.emptyContainer}>
          <Text style={styles.emptyIcon}>üì≠</Text>
          <Text style={styles.emptyTitle}>No offers yet</Text>
          <Text style={styles.emptyText}>
            {selectedFilter === 'all' 
              ? 'Start making offers on needs to see them here'
              : `No ${selectedFilter} offers`}
          </Text>
          <TouchableOpacity 
            style={styles.browseButton}
            onPress={() => navigation.navigate('NeedsFeed')}
          >
            <Text style={styles.browseButtonText}>Browse Needs</Text>
          </TouchableOpacity>
        </View>
      ) : (
        <ScrollView 
          style={styles.offersList}
          refreshControl={<RefreshControl refreshing={refreshing} onRefresh={onRefresh} />}
        >
          {filteredOffers.map((offer) => {
            const config = statusConfig[offer.status] || statusConfig.pending;
            return (
              <TouchableOpacity
                key={offer.id}
                style={styles.offerCard}
                onPress={() => {
                  if (offer.status === 'accepted') {
                    // For accepted offers, navigate to order tracking
                    navigation.navigate('SellerOrders');
                  } else {
                    navigation.navigate('OfferDetails', { offerId: offer.id });
                  }
                }}
              >
                <View style={styles.offerHeader}>
                  <View style={styles.offerHeaderLeft}>
                    <Text style={styles.offerNeedTitle} numberOfLines={1}>
                      {offer.needTitle || 'Need'}
                    </Text>
                    <Text style={styles.offerCategory}>{offer.needCategory || 'Category'}</Text>
                  </View>
                  <View style={[styles.statusBadge, { backgroundColor: config.bgColor }]}>
                    <Text style={[styles.statusText, { color: config.color }]}>
                      {config.emoji} {config.label}
                    </Text>
                  </View>
                </View>

                <View style={styles.offerDetails}>
                  <View style={styles.offerDetailRow}>
                    <Text style={styles.offerDetailLabel}>Your Offer:</Text>
                    <Text style={styles.offerDetailValue}>{formatCurrency(offer.amount || offer.price)}</Text>
                  </View>
                  <View style={styles.offerDetailRow}>
                    <Text style={styles.offerDetailLabel}>Delivery:</Text>
                    <Text style={styles.offerDetailValue}>{offer.deliveryTime || offer.estimatedDeliveryDays || 'N/A'}</Text>
                  </View>
                </View>

                {offer.description && (
                  <Text style={styles.offerMessage} numberOfLines={2}>
                    {offer.description}
                  </Text>
                )}

                <View style={styles.offerFooter}>
                  <Text style={styles.offerBuyer}>To: {offer.buyerName || 'Buyer'}</Text>
                  <Text style={styles.offerTime}>{getTimeAgo(offer.createdAt)}</Text>
                </View>
              </TouchableOpacity>
            );
          })}
        </ScrollView>
      )}
    </SafeAreaView>
  );
}

const styles = StyleSheet.create({
  container: { flex: 1, backgroundColor: colors.background },
  header: { padding: 20, paddingBottom: 16, flexDirection: 'row', justifyContent: 'space-between', alignItems: 'flex-start' },
  title: { fontSize: 28, fontWeight: 'bold', color: colors.text, marginBottom: 4 },
  subtitle: { fontSize: 16, color: colors.textSecondary },
  settingsButton: { width: 44, height: 44, borderRadius: 22, backgroundColor: colors.white, alignItems: 'center', justifyContent: 'center', borderWidth: 1, borderColor: colors.border },
  settingsIcon: { fontSize: 22 },
  statsContainer: { flexDirection: 'row', paddingHorizontal: 20, marginBottom: 20, gap: 12 },
  statCard: { flex: 1, padding: 16, borderRadius: 12, alignItems: 'center' },
  statNumber: { fontSize: 28, fontWeight: 'bold', color: colors.text, marginBottom: 4 },
  statLabel: { fontSize: 12, color: colors.textSecondary, fontWeight: '600' },
  searchContainer: { marginHorizontal: 20, marginBottom: 16, flexDirection: 'row', alignItems: 'center', backgroundColor: colors.white, borderRadius: 12, paddingHorizontal: 16, borderWidth: 1, borderColor: colors.border },
  searchIcon: { fontSize: 20, marginRight: 8 },
  searchInput: { flex: 1, paddingVertical: 12, fontSize: 16, color: colors.text },
  filtersScroll: { maxHeight: 50, marginBottom: 16 },
  filterChip: { marginLeft: 20, paddingHorizontal: 16, paddingVertical: 8, borderRadius: 20, backgroundColor: colors.backgroundSecondary, borderWidth: 1, borderColor: colors.border },
  filterChipActive: { backgroundColor: colors.primary, borderColor: colors.primary },
  filterChipText: { fontSize: 14, color: colors.text, fontWeight: '500' },
  filterChipTextActive: { color: colors.white },
  loadingContainer: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  loadingText: { marginTop: 16, fontSize: 16, color: colors.textSecondary },
  emptyContainer: { flex: 1, justifyContent: 'center', alignItems: 'center', paddingHorizontal: 40 },
  emptyIcon: { fontSize: 64, marginBottom: 16 },
  emptyTitle: { fontSize: 20, fontWeight: '700', color: colors.text, marginBottom: 8 },
  emptyText: { fontSize: 14, color: colors.textSecondary, textAlign: 'center', marginBottom: 24 },
  browseButton: { backgroundColor: colors.primary, paddingHorizontal: 24, paddingVertical: 12, borderRadius: 20 },
  browseButtonText: { color: colors.white, fontSize: 14, fontWeight: '600' },
  offersList: { flex: 1, paddingHorizontal: 20 },
  offerCard: { backgroundColor: colors.white, borderRadius: 16, padding: 16, marginBottom: 16, borderWidth: 1, borderColor: colors.border },
  offerHeader: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 12 },
  offerHeaderLeft: { flex: 1, marginRight: 12 },
  offerNeedTitle: { fontSize: 16, fontWeight: '700', color: colors.text, marginBottom: 4 },
  offerCategory: { fontSize: 12, color: colors.textSecondary, textTransform: 'uppercase', fontWeight: '600' },
  statusBadge: { paddingHorizontal: 12, paddingVertical: 6, borderRadius: 12 },
  statusText: { fontSize: 12, fontWeight: '700' },
  offerDetails: { marginBottom: 12 },
  offerDetailRow: { flexDirection: 'row', justifyContent: 'space-between', marginBottom: 6 },
  offerDetailLabel: { fontSize: 14, color: colors.textSecondary },
  offerDetailValue: { fontSize: 14, fontWeight: '600', color: colors.text },
  offerMessage: { fontSize: 14, color: colors.textSecondary, fontStyle: 'italic', marginBottom: 12, lineHeight: 20 },
  offerFooter: { flexDirection: 'row', justifyContent: 'space-between', paddingTop: 12, borderTopWidth: 1, borderTopColor: colors.border },
  offerBuyer: { fontSize: 13, color: colors.textSecondary },
  offerTime: { fontSize: 12, color: colors.textLight },
});
