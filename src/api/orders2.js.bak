import AsyncStorage from '@react-native-async-storage/async-storage';
import { AppConfig } from '../config/app';
import { mockOrders } from '../data/mock';

const API_URL = AppConfig.API_URL;

export const ordersAPI = {
  getAll: async () => {
    // ðŸŽ­ MOCK MODE
    if (AppConfig.USE_MOCK_DATA) {
      console.log('ðŸŽ­ MOCK: Getting all orders');
      await new Promise(resolve => setTimeout(resolve, 500));
      return {
        success: true,
        orders: mockOrders
      };
    }
    
    // ðŸ”´ REAL API
    try {
      const token = await AsyncStorage.getItem('userToken');
      const response = await fetch(`${API_URL}/orders`, {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Get all orders error:', error);
      return { success: false, message: error.message };
    }
  },

  getMyOrders: async (type = 'all') => {
    // ðŸŽ­ MOCK MODE
    if (AppConfig.USE_MOCK_DATA) {
      console.log('ðŸŽ­ MOCK: Getting my orders', type);
      await new Promise(resolve => setTimeout(resolve, 500));
      
      let filtered = [...mockOrders];
      if (type === 'buyer') {
        filtered = mockOrders.filter(o => o.buyerId === 'buyer-1');
      } else if (type === 'seller') {
        filtered = mockOrders.filter(o => o.sellerId && o.sellerId.startsWith('seller-'));
      }
      
      return {
        success: true,
        orders: filtered
      };
    }
    
    // ðŸ”´ REAL API
    try {
      const token = await AsyncStorage.getItem('userToken');
      const url = type === 'all' 
        ? `${API_URL}/orders/my`
        : `${API_URL}/orders/my?type=${type}`;
        
      const response = await fetch(url, {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Get my orders error:', error);
      return { success: false, message: error.message };
    }
  },

  getById: async (orderId) => {
    // ðŸŽ­ MOCK MODE
    if (AppConfig.USE_MOCK_DATA) {
      console.log('ðŸŽ­ MOCK: Getting order by ID', orderId);
      await new Promise(resolve => setTimeout(resolve, 500));
      const order = mockOrders.find(o => o.id === orderId);
      return {
        success: !!order,
        order: order || null,
        message: order ? '' : 'Order not found'
      };
    }
    
    // ðŸ”´ REAL API
    try {
      const token = await AsyncStorage.getItem('userToken');
      const response = await fetch(`${API_URL}/orders/${orderId}`, {
        headers: { 'Authorization': `Bearer ${token}` },
      });
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Get order by ID error:', error);
      return { success: false, message: error.message };
    }
  },

  updateStatus: async (orderId, status) => {
    // ðŸŽ­ MOCK MODE
    if (AppConfig.USE_MOCK_DATA) {
      console.log('ðŸŽ­ MOCK: Updating order status', orderId, status);
      await new Promise(resolve => setTimeout(resolve, 500));
      return {
        success: true,
        message: `Order status updated to ${status}`
      };
    }
    
    // ðŸ”´ REAL API
    try {
      console.log('ðŸ”„ Updating order status:', orderId, status);
      
      const token = await AsyncStorage.getItem('userToken');
      const response = await fetch(`${API_URL}/orders/${orderId}/status`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify({ status })
      });

      const data = await response.json();
      console.log('âœ… Update status response:', data);
      
      return data;
    } catch (error) {
      console.error('Update order status error:', error);
      return { success: false, message: error.message };
    }
  },

  createRating: async (orderId, rating) => {
    // ðŸŽ­ MOCK MODE
    if (AppConfig.USE_MOCK_DATA) {
      console.log('ðŸŽ­ MOCK: Creating rating', orderId, rating);
      await new Promise(resolve => setTimeout(resolve, 500));
      return {
        success: true,
        message: 'Rating submitted successfully'
      };
    }
    
    // ðŸ”´ REAL API
    try {
      const token = await AsyncStorage.getItem('userToken');
      const response = await fetch(`${API_URL}/orders/${orderId}/rating`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
        },
        body: JSON.stringify(rating),
      });
      const data = await response.json();
      return data;
    } catch (error) {
      console.error('Create rating error:', error);
      return { success: false, message: error.message };
    }
  },
};
